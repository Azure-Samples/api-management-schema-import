# API Management Schemas Import

This repository contains the source code for many tools that are useful to work with WSDL files in [Azure API Management](https://azure.microsoft.com/en-us/services/api-management/):
* **WSDLProcessor**: Takes a WSDL file as an input and outputs another WSDL file with references through the wsdl:imports, XSD import, and XSD include directives resolved and merged inline. The references are resolved from the local filesystem or through a URL.
* **XMLSchemaProcessor**: Takes a folder with XSD files, renames them based on Azure Resource Manager naming requirements, and creates an upload sequence for uploading those schemas into Azure API Management - starting from the dependency leaf elements to the top-level parent.
* **PowerShell tools**:
    * **uploadschemas.ps1**: Upload the XSD schema files generated by the XMLSchemaProcessor to your Azure API Management service.
    * **batchWsdlProcessor.ps1**: Executes WSDLProcessor on all WSDL files with location specified in a JSON file and uploads the generated WSDL files into your Azure API Management service.
    * **batchXmlSchemaProcessor.ps1**: Executes XMLSchemaProcessor for all folders listed in a JSON file and uploads the generated XSD schemas into your Azure API Management service.
## Features
### WSDLProcessor
This project framework provides the following features:

* Detect/resolve/inline all wsdl:imports
* Detect/resolve/inline all xsd:imports in xml schemas
* Detect/resolve/inline all xsd:includes in xml schemas
* Merge all xml schemas with the same targetnamespace into a single schema
* The tool produces a single wsdl file to a path passed as a second parameter: **tool.exe "c:\foo\bar\in.wsdl" "d:\buzz\quix\out.wsdl"**
* The tool is able to resolve following types of references:
    * http/https absolute urls. Any non-200 response is a failure.
    * Absolute local filesystem location.
    * Relative local filesystem location. For the base location the tool uses current file location, **not root file location and not the location of the tool itself**.
### XMLSchemaProcessor
This tool provides the following features:
* The tool accepts two command line parameters, the first one points to a folder with all schemas, the second one to the output folder.
* The tool produces single file upload-plan.json inside provided folder (second parameter).
* The tool performs the following steps:
    * Iterate through all files in the folder with *.xsd extension
    * Detect all xsd imports and includes
    * **Fail immediately if any import or include doesn't have schemaLocation or the value is not a local file location**
    * For each file name generates compliant ARM resource name:
        * Drop file extension.
        * Replace all non-alphanumeric symbols with a single dash.
        * Examples: foo.xsd -> foo, foo_1.xsd -> foo-1, foo_1_2.xsd -> foo-1-2, etc.
    * Replace schemaLocation with a reference to a well-formed ARM schema resource: foo.xsd -> /schemas/foo, foo_1_2.xsd -> /schemas/foo-1-2
    * Build dependency graph between all schema files
    * Write single json document in the output file with property names corresponding to file names and property values corresponding to ARM names in the order of dependency. Example: foo.xsd depends on foo_1_2.xsd. upload-plan.json should contain: { "foo_1_2.xsd": "foo-1-2", "foo.xsd": "foo" }
* The tool fails on the first error with the descriptive error message in standard output.

### PowerShell tool to upload generated XML Schemas
This Powershell script(uploadschemas.ps1) provides the following features:
* The tool accepts two command line parameters:
    * Location of json file generated by schema processing tool (XMLSchemaProcessor).
    * APIM resource url, e.g. https://management.azure.com/subscriptions/{subid}/resourceGroups/{rgname}/providers/Microsoft.ApiManagement/service/{servicename}.
* Acquires Azure auth token for current user.
* Iterates through schemas in json file and upload to the APIM service using HTTP calls.
* Tool fails on first failure.

### PowerShell tool to generate WSDL merged files and upload them to APIM
This Powershell script(batchWsdlProcessor.ps1) provides the following features:
* The tool accepts three command line parameters:
    * Full path of json config file that should look like:
	`{"wsdlFileName.wsdl" : "DirectoryPathOfWsdlFile", ...}`
    * APIM resource url, e.g. https://management.azure.com/subscriptions/{subid}/resourceGroups/{rgname}/providers/Microsoft.ApiManagement/service/{servicename}.
    * WSDL Processor Path, e.g. `C:\myPathParent\myPathChild\...\Microsoft.Azure.ApiManagement.WsdlProcessor.App.exe`
* Acquires Azure auth token for current user.
* Iterates through json config file and generates new WSDL file with merged schemas, then It uploads the new WSDL file to the APIM service using HTTP calls.
* Tool fails on first failure

### PowerShell tool to generate new XML schemas and upload them to APIM
This Powershell script(batchXmlSchemaProcessor.ps1) provides the following features:
* The tool accepts three command line parameters:
    * Full path of json config file that should look like:
	`{"inputDirectoryWithSchemas" : "OutputDirectory", ...}`
    * APIM resource url, e.g. https://management.azure.com/subscriptions/{subid}/resourceGroups/{rgname}/providers/Microsoft.ApiManagement/service/{servicename}.
    * XML Schema Processor Path, e.g. `C:\myPathParent\myPathChild\...\Microsoft.Azure.ApiManagement.XmlSchemaProcessor.App.exe`
* Acquires Azure auth token for current user.
* Iterates through json config file and generates new XML schema files and an upload-plan.json for each entry, then It uploads the new XML schema files to the APIM service using the upload plan files and HTTP calls.
* Tools fails on first failure.
## Getting Started

### Prerequisites
- OS: Windows, Linux, MacOS.
- Library version: .NET 5.0
- Powershell
- .NET Command Line
- Azure Cli

### Installation WSDLProcessor

When you have the .NET Command Line installed on your OS of choice, you can download the code and go to Microsoft.Azure.ApiManagement.WsdlProcessor.App directory. 

First, you will need to restore the packages:
	
	dotnet restore
	
This will restore all of the packages that are specified in the csproj file of the given project.

Compiling to IL is done using:
	
	dotnet build

This will drop a binary in `./bin/[configuration]/[net5.0]/[Microsoft.Azure.ApiManagement.WsdlProcessor.App.exe]` that you can just run.

You can run the binary in this way:
	
	c:\folder\Microsoft.Azure.ApiManagement.WsdlProcessor.App.exe "mywsdlfile.wsdl" "myoutputwsdlfile-processed.wsdl""
	
### Installation XmlSchemaProcessor

When you have the .NET Command Line installed on your OS of choice, you can download the code and go to Microsoft.Azure.ApiManagement.XmlSchemaProcessor.App directory. 

First, you will need to restore the packages:
	
	dotnet restore
	
This will restore all of the packages that are specified in the csproj file of the given project.

Compiling to IL is done using:
	
	dotnet build

This will drop a binary in `./bin/[configuration]/[net5.0]/[Microsoft.Azure.ApiManagement.XmlSchemaProcessor.App.exe]` that you can just run.

You can run the binary in this way:
	
	c:\folder\Microsoft.Azure.ApiManagement.XmlSchemaProcessor.App.exe "c:\schemaslocation\" "c:\schemaslocation\output\""
### Powershell UploadSchemas Quickstart
	
	uploadschemas.ps1 "upload-planLocationFile" "APIM Resource URL"
### Powershell batchWsdlProcessor Quickstart
	
	batchWsdlProcessor.ps1 "C:\myPathParent\myPathChild\...\wsdlFiles.json" "https://management.azure.com/subscriptions/{subid}/resourceGroups/{rgname}/providers/Microsoft.ApiManagement/service/{servicename}" "c:\folder\Microsoft.Azure.ApiManagement.WsdlProcessor.App.exe"
### Powershell batchXmlSchemaProcessor Quickstart
	
	batchXmlSchemaProcessor.ps1 "C:\myPathParent\myPathChild\...\xmlSchemaFolders.json" "https://management.azure.com/subscriptions/{subid}/resourceGroups/{rgname}/providers/Microsoft.ApiManagement/service/{servicename}" "c:\folder\Microsoft.Azure.ApiManagement.XmlSchemaProcessor.App.exe"
### Quickstart
1. git clone https://github.com/Azure-Samples/api-management-schema-import.git
2. cd **api-management-schema-import**


## Resources
- [.NET 5.0](https://dotnet.microsoft.com/en-us/download/dotnet/5.0)
- [.NET Command Line](https://docs.microsoft.com/en-us/dotnet/core/tools/)
- [WSDL Schema Files](http://schemas.xmlsoap.org/wsdl/)
- [Azure](https://azure.microsoft.com/en-us/)
